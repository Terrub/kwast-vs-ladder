<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />

    <title>Kwast en Ladder</title>

    <script src="utils.js"></script>
    <script src="mainLoop.js"></script>
    <script src="display.js"></script>

    <style type="text/css">
      body {
        color: #333;
        margin: 0;
        padding: 0;
        background-color: #ccc;
        font-family: Arial, Helvetica, sans-serif;
      }

      #gameBoardContainer {
        width: 100%;
        height: 100%;
        display: grid;
        justify-content: center;
        align-content: center;
        z-index: 1;
      }

      #gameBoard {
        width: fit-content;
        height: fit-content;
        display: grid;
        justify-content: center;
        align-content: center;
      }

      #scoreBoard {
        position: fixed;
        font-size: 1.5em;
      }

      #gamePoints {
        color: #0a0;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      let gameCanvas;
      let gameDisplay;
      let position;
      let jumpPosition;
      let gameWidth;
      let gameHeight;
      let charWidth;
      let charHeight;
      let ladderWidth;
      let ladderHeight;
      let occurances;

      function calculateJumpHeight(position) {
        // Not currently jumping, hard return
        if (isUndefined(jumpPosition)) {
          return 0;
        }

        // Calc delta X between now and when jump started
        const x = position - jumpPosition;

        // Use that X to Calc Y with polynomial: y = -x^2 + 25x
        return -1 * (x * x) + 25 * x;
      }

      function drawLadder(display, position, occurances) {
        for (const occurance of occurances) {
          const x = gameWidth - (position % (occurance * gameWidth));
          if (0 < x && x < gameWidth) {
            const y = Math.floor(gameHeight / 2);
            const c = "#333";
            display.drawLine(x, y, x, y - ladderHeight, c, 3);
            display.drawLine(
              x + ladderWidth,
              y,
              x + ladderWidth,
              y - ladderHeight,
              c,
              3
            );
            for (let h = 15; h < ladderHeight; h += 15) {
              display.drawLine(x, y - h, x + ladderWidth, y - h, c, 2);
            }
          }
        }
      }

      function drawBackground(display, position) {
        const lineWidth = 2;
        const y = Math.floor((gameHeight + lineWidth) / 2);

        display.drawRect(0, 0, gameWidth, gameHeight, "#ddd");
        display.drawLine(0, y, gameWidth, y, "#333", lineWidth);

        // Lets add a wall section, something like this.
        //         ______
        //    _|_____|_____
        //      __|____
        const wallX = gameWidth - (position % gameWidth);
        const yOff = Math.floor(gameHeight / 2) - 100;
        if (0 < wallX && wallX < gameWidth) {
          // Horizontal
          display.drawLine(
            wallX + 40,
            yOff + 35,
            wallX + 80,
            yOff + 35,
            "#333",
            2
          );
          display.drawLine(wallX, yOff + 45, wallX + 90, yOff + 45, "#333", 2);
          display.drawLine(wallX, yOff + 55, wallX + 70, yOff + 55, "#333", 2);
          // Vertical
          display.drawLine(
            wallX + 10,
            yOff + 35,
            wallX + 10,
            yOff + 35 + 10,
            "#333",
            2
          );
          display.drawLine(
            wallX + 60,
            yOff + 35,
            wallX + 60,
            yOff + 35 + 10,
            "#333",
            2
          );
          display.drawLine(
            wallX + 35,
            yOff + 45,
            wallX + 35,
            yOff + 45 + 10,
            "#333",
            2
          );
        }
      }

      function drawCharacter(display, jumpHeight) {
        if (jumpHeight < 0) {
          // Jump concluded, reset
          jumpPosition = undefined;
          jumpHeight = 0;
        }
        const x = Math.floor(gameWidth / 2);
        const y = Math.floor(gameHeight / 2) - charHeight - jumpHeight;

        display.drawRect(x, y, charWidth, charHeight, "#333");
      }

      function checkForCollisions(position, y, occurances) {
        const offset = Math.floor(gameWidth / 2) - ladderWidth;

        for (const occurance of occurances) {
          const x = gameWidth - (position % (occurance * gameWidth));
          if (
            x >= offset &&
            x <= offset + charWidth + ladderWidth &&
            y < ladderHeight
          ) {
            return true;
          }
        }

        return false;
      }

      function updatePointScore() {
        document.getElementById("gamePoints").innerText = position;
      }

      function displayGameOver() {
        const gameStateTextElem = document.getElementById("gameStateText");
        gameStateTextElem.style.setProperty("color", "red");
        gameStateTextElem.innerText = "GAME OVER!";
      }

      function gameTic() {
        position += 1;
        drawBackground(gameDisplay, position * 8);
        drawLadder(gameDisplay, position * 12, occurances);
        // drawLadder(gameDisplay, position, 23);
        // drawBucket(gameDisplay, position, 22);
        // drawBucketCluster(gameDisplay, position, 22);
        let jumpHeight = calculateJumpHeight(position);
        drawCharacter(gameDisplay, jumpHeight);

        updatePointScore();
        const hit = checkForCollisions(position * 12, jumpHeight, occurances);
        if (hit) {
          mainLoop.stop();
          displayGameOver();
        }
      }

      function keyPressEventHandler(keyboardEvent) {
        if (keyboardEvent.code === "Space" && isUndefined(jumpPosition)) {
          jumpPosition = position;
        }
      }

      function init() {
        gameWidth = 1000;
        gameHeight = 620;
        charWidth = 35;
        charHeight = 90;
        ladderWidth = 25;
        ladderHeight = 120;
        occurances = [2, 3, 5];

        gameCanvas = document.getElementById("gameCanvas");
        gameCanvas.width = gameWidth;
        gameCanvas.height = gameHeight;
        gameDisplay = createDisplayFromCanvas(gameCanvas);
        position = 0;
        mainLoop = mainLoop(gameTic);
        mainLoop.start();
        document.addEventListener("keypress", keyPressEventHandler);
      }

      //   debugger;
      window.onload = init;
    </script>
    <div id="scoreBoard">
      <!-- <button id="btn_next" onclick="mainLoop.next();">>>></button>
      <button id="btn_start" onclick="mainLoop.start();">Start</button>
      <button id="btn_stop" onclick="mainLoop.stop();">Stop</button> -->
      <label>
        Points: <span id="gamePoints">0</span>
        <span id="gameStateText"></span>
      </label>
    </div>
    <div id="gameBoardContainer">
      <div id="gameBoard">
        <canvas id="gameCanvas"></canvas>
      </div>
    </div>
  </body>
</html>
